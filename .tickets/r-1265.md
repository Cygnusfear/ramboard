---
id: r-1265
status: closed
deps: []
links: [r-0cc6]
created: 2026-03-01T12:02:00Z
type: task
priority: 3
assignee:
tags: [mid-mortem, compaction]
---

# Mid-mortem: Context Menu Unification + Architecture Review

Session checkpoint before context compaction. Three tasks completed, one pending.

---

## What Was Being Worked On

Three sequential tasks from the hooman, all related to list-view and context menus:

1. **Tag overflow fix** — Tags in list-view rows were always truncated to `max={2}` even with plenty of horizontal space
2. **Context menu unification** — "Labels (Coming soon)" placeholder → working Tags submenu; add Type submenu; deduplicate the inline context menu in ticket-detail.tsx with the shared one in ticket-context-menu.tsx
3. **Architecture review** — Hooman noticed the work was heavier than it should be, asked for an oracle review with playbook 30.xx and 40.xx principles

---

## Decisions Made

### Tag auto-measure (completed)
- `TagList` now has two modes: hard `max` prop (board cards, tight space) vs auto-measure (no `max`, uses `useLayoutEffect` to check which pills fit before paint)
- Board column keeps `max={2}`, list-view removed it
- Measurement happens in a single synchronous layout pass — no flash

### Context menu consolidation (completed)
- `MenuActions` interface expanded with `onSetType` and `onToggleTag`
- "Labels" → "Tags" — shows all known project tags with checkmarks (✓ = all selected have it, — = some)
- Type submenu added (Task/Bug/Feature/Epic/Chore)
- `ticket-detail.tsx` replaced ~60 lines of inline `ContextMenu.Root/Trigger/Portal` with shared `<TicketContextMenu hideOpen triggerClassName="overflow-auto">`
- `hideOpen` prop suppresses "Open ticket" item when already on detail page

### Architecture anti-pattern identified (oracle r-0cc6)
- **Callback-threading anti-pattern**: `MenuContent` reads the store directly (tags) but routes all mutations through 11-hop callback chains (store → ref → handler → ref → stable wrapper → prop)
- Adding one new action requires touching **11 places** across 3 files
- Oracle verdict: Move mutations into a `useMenuActions(ticketIds)` hook inside `ticket-context-menu.tsx`. Only `onOpen` stays as external callback (context-specific navigation). Deletes ~55 net lines.
- This is **Option B** from oracle ticket r-0cc6

---

## Progress

### ✅ Done
- `src/components/tag-pill.tsx` — Rewrote with auto-measure mode (useLayoutEffect, ResizeObserver-ready)
- `src/components/list-view.tsx` — Removed `max={2}` from TagList, wired up `onSetType`/`onToggleTag`/`onSetPriority` (was a no-op TODO), updated menuActionsRef chain
- `src/components/ticket-context-menu.tsx` — Expanded `MenuActions`, added Tags submenu (with toggle + checkmarks), added Type submenu, added `hideOpen`/`triggerClassName` props
- `src/components/ticket-detail.tsx` — Replaced inline context menu with shared `TicketContextMenu`
- Build passes (frontend tsc clean, only pre-existing Bun server-side type errors)
- Oracle architecture review completed → ticket r-0cc6

### ⏳ Not Done — Pending Human Approval
- **Refactor to `useMenuActions` hook** (Option B from oracle r-0cc6) — Human was asked "Want me to implement Option B?" at session end. No response yet.

---

## Open Threads

1. **Implement `useMenuActions` hook** — Oracle r-0cc6 recommends moving all store mutations into a hook inside `ticket-context-menu.tsx`. Only `onOpen` stays as a callback prop. This would cut the 11-place-per-action overhead to 1-file-per-action. Human seemed favorable ("are we sure the architecture isn't wrong?") but didn't explicitly greenlight. **Ask before starting.**

2. **Tag toggle pure function** — Oracle's Option C suggests extracting `toggleTag(currentTags, tag) → newTags` as a pure function. Minor but clean. Bundle with Option B.

3. **Board column context menu** — `board-column.tsx` still uses `TagList max={2}` (correct for tight cards) but its context menu may also benefit from the shared component. Not investigated yet.

---

## Gotchas & Learnings

- **`useLayoutEffect` for measurement**: The auto-measure TagList works by rendering all tags, measuring in `useLayoutEffect` (before paint), then re-rendering with only fitting tags. No flash. The key insight: the parent must have `overflow-hidden` for the clip boundary to be meaningful.

- **Store already imported in MenuContent**: The menu component already reads `useTicketStore` for the tag list. The asymmetry of "reads from store, writes through callbacks" was the core smell. Future work should just let the menu write to the store directly.

- **Ref-based stable callbacks pattern in list-view**: The `menuActionsRef` → `useState(() => wrapper)` pattern exists to avoid re-renders on every tick. It's clever but becomes a maintenance tax when the interface grows. The `useMenuActions` hook would eliminate it entirely for menu actions.

- **`tsc --noEmit` check**: Frontend-only check with `bunx tsc --noEmit -p tsconfig.app.json` avoids false positives from server-side Bun type issues.

---

## Files Modified This Session

| File | What changed |
|------|-------------|
| `src/components/tag-pill.tsx` | Rewrote TagList with auto-measure mode |
| `src/components/list-view.tsx` | Removed tag max, wired new actions, fixed priority no-op |
| `src/components/ticket-context-menu.tsx` | Tags/Type submenus, MenuActions expanded, hideOpen/triggerClassName |
| `src/components/ticket-detail.tsx` | Replaced inline ctx menu with shared TicketContextMenu |

## Related Tickets

- **r-0cc6** — Oracle architecture review with full findings and recommended fix (Option B)
