---
id: r-59c3
status: closed
deps: []
links: []
created: 2026-03-01T10:48:19Z
type: task
priority: 1
assignee: Alexander Mangel
tags: [research, oracle, architecture]
---
# Oracle 2: Full 30+40 Architectural Review — Ramboard src/


## Notes

**2026-03-01T10:48:35Z**

## Overview

> Oracle: oracle-2 (r-433e) | Delphi parent: r-e89a
> Method: Read all 47 source files + 8 playbook files + prior research (r-0cc6)
> Skepticism: Independent analysis, did NOT start from oracle-1's conclusions

The codebase is well-structured overall. Problems are concentrated, not systemic.
The prior research (r-0cc6) correctly identified the menu anti-pattern — it has since been fixed.

## Dead Code Findings

**DC-1 [HIGH]: src/lib/drag-select.ts — 131 lines, zero imports**
- Provides: createDragSelectState, dragStart, dragMove, dragEnd, dragClear, dragSelectAll
- Superseded by list-interaction.ts (integrated drag logic)
- Confirmed: rg 'drag-select' src/ shows only a comment in list-interaction.ts, no imports
- Action: DELETE

**DC-2 [HIGH]: filter-engine.ts — serializeFilters/deserializeFilters exported but never imported**
- use-filter-url-sync.ts has its own serialization (multi-param: f=, q=, sf=, sd=)
- filter-engine.ts versions use different format (single encodeURIComponent param)
- Confirmed: zero import sites found
- Action: DELETE both from filter-engine.ts

**DC-3 [MEDIUM]: api.ts — toggleCheckbox exported, never imported**
- May be future (TipTap checkboxes), but currently dead
- Action: IMPLEMENT or DELETE

**DC-4 [MEDIUM]: keybindings.ts — 'p' (cycle-priority) and 'X' (range-select) never implemented**
- Both appear in keyboard help dialog but use-keyboard.ts has no case for them
- Effect: Users see shortcuts that do nothing
- Action: IMPLEMENT or REMOVE

**DC-5 [LOW]: src/components/ticket-detail-edit.plan.md inside src/components/**
- Planning document committed to source directory
- Action: MOVE to docs/ or DELETE

**2026-03-01T10:48:56Z**

## Convergence Failures (30.02)

**CF-1 [MEDIUM]: STATUS_LABELS defined twice**
- src/lib/types.ts:32 — canonical exported definition
- src/components/status-dot.tsx:15 — private copy, identical values
- status-dot.tsx imports types.ts for other things but not STATUS_LABELS
- Fix: Delete from status-dot.tsx, import from '@/lib/types'

**CF-2 [MEDIUM]: Status cycle rule duplicated**
- list-interaction.ts:27-31: STATUS_CYCLE = { open:'in_progress', in_progress:'closed', closed:'open' }
- ticket-detail.tsx:50-52: identical ternary chain
- Both implement the same business rule: cycle open→in_progress→closed→open
- Fix: Extract to lib/ticket-workflow.ts as pure function cycleStatus(status: string): string

**CF-3 [MEDIUM]: allTags computation duplicated**
- ticket-context-menu.tsx:93-100: useMemo that collects unique tags from all tickets, sorted
- tag-editor.tsx:28-35: identical useMemo
- Fix: Extract to hooks/use-all-tags.ts

**CF-4 [MEDIUM]: SORT_FIELDS defined twice**
- board-view.tsx:214: SORT_FIELD_OPTIONS (5 entries, label+value)
- column-editor.tsx:8: SORT_FIELDS (5 entries, same data, different name)
- Fix: Export SORT_FIELD_OPTIONS from lib/types.ts, import in both

**CF-5 [MEDIUM]: TICKET_ID_RE regex defined twice**
- lib/linkify-ticket-ids.tsx:11: const TICKET_ID_RE = /\b([a-z0-9]{1,5}-[a-z0-9]{3,5})\b/gi
- components/ticket-link-plugin.ts:11: identical regex
- Fix: Export from lib/linkify-ticket-ids.tsx (or new lib/ticket-ids.ts), import in plugin

**CF-6 [HIGH]: Filter serialization dead + duplicated**
- filter-engine.ts exports serializeFilters/deserializeFilters (DEAD — 0 imports)
- use-filter-url-sync.ts has its own serializeToSearch/deserializeFromSearch (LIVE)
- Different formats; filter-engine versions are orphaned
- Fix: Delete filter-engine.ts serialization functions

**CF-7 [MEDIUM]: STATUS_COLORS semantic inconsistency**
- status-dot.tsx: open=emerald(green), in_progress=amber, closed=zinc(grey), cancelled=red
- graph-view.tsx: open=#a1a1aa(zinc/grey), in_progress=#60a5fa(blue), closed=#4ade80(green), cancelled=zinc-500
- 'open' is green in list view but grey in graph. 'closed' is grey in list but green in graph.
- Not code duplication per se, but visual inconsistency for users

**2026-03-01T10:49:16Z**

## Dependency Direction Violations (40.03)

**DD-1 [HIGH]: lib/linkify-ticket-ids.tsx imports components/**
lib/linkify-ticket-ids.tsx line 4:
  import { TicketLink } from '@/components/ticket-link'
A lib/ module importing from the presentation layer is an upward dependency violation.
lib/ should be pure, component-agnostic.
Fix options:
- Option A (simpler): Move linkify-ticket-ids.tsx to components/
- Option B (pure): Refactor to return token array, component creates TicketLink
Recommend Option A.

**DD-2 [MEDIUM]: filter-store → view-store circular dependency**
filter-store.ts line ~35:
  function notifyDirty() {
    // Dynamic import to avoid circular deps — view-store imports are lazy
    import('@/stores/view-store').then(m => m.useViewStore.getState().markDirty())
  }
The circular dependency is real and acknowledged in the comment.
Fix: app.tsx already subscribes to both stores. Subscribe to filterStore changes
in app.tsx and call useViewStore.getState().markDirty() from there.
Remove notifyDirty() and the dynamic import from filter-store entirely.

**DD-3 [MEDIUM]: view-store bypasses lib/api.ts**
- project-store.ts, ticket-store.ts: use lib/api.ts fetchJson wrapper (correct)
- view-store.ts: calls fetch() directly with no error handling
- The view API endpoints are not in api.ts
- Fix: Add getViews, createView, updateView, deleteView to lib/api.ts

## State Ownership Violations (40.01)

**SO-1 [MEDIUM]: STATUS_LABELS has two 'owners'**
- Same as CF-1. The canonical definition in types.ts and a private copy in status-dot.tsx.

**SO-2 [MEDIUM]: getDefaultValue in wrong module**
- filter-store.ts exports getDefaultValue — a pure computation function
- column-editor.tsx imports it from the store
- Pure functions belong in lib/, not stores
- Fix: Move to filter-engine.ts, update import in column-editor.tsx

## Domain Logic Separation (40.04)

**DLS-1 [MEDIUM]: Status cycle rule buried in list-interaction.ts**
- STATUS_CYCLE constant is private, untestable without spinning up the state machine
- Same rule exists in ticket-detail.tsx (see CF-2)
- Fix: Extract to lib/ticket-workflow.ts as exportable pure function

**DLS-2 [MEDIUM]: useProjectViewSetup hook defined inside app.tsx**
- Complex hook with 4 useEffects managing: activeTicket clearing, ticket+view fetching,
  URL viewId sync, saved view filter loading
- Not in hooks/ — can't be tested or reused independently
- Fix: Extract to src/hooks/use-project-view-setup.ts

**DLS-3 [LOW]: getVisibleTickets() inline in use-keyboard.ts**
- A domain query function (run applyFiltersAndSort imperatively) embedded in keyboard module
- Minor, but could be a shared utility

**2026-03-01T10:49:42Z**

## What Is GOOD About The Architecture

1. **list-interaction.ts is textbook 40.04** — 301-line pure TS state machine, zero React/DOM.
   The React component is thin glue: calls machine methods, renders machine state.

2. **Context menu fix (r-0cc6) correctly implemented** — useMenuActions() hook is
   self-contained, zero callback threading, no ref chains. Confirmed by code review.

3. **filter-engine.ts is clean domain logic** — 100% pure functions. testable without mocks.

4. **filter-primitives.tsx correctly shared** — FilterEditor, FilterRow, MultiSelectEditor shared
   between filter-bar.tsx (list view) and column-editor.tsx (board view) with zero duplication.

5. **tag-mutations.ts correctly extracted** — toggleTagForTickets() is pure, correctly placed in lib/.

6. **Store ownership is clear** — Each Zustand store owns a clear domain, no circular imports
   (except the filter→view workaround).

7. **useFilteredTickets uses primitive selectors** — Prevents the infinite render loop (fixed r-90d6).

8. **useNavigate centralizes view transitions** — Auto-detects transition type from URL patterns.

9. **Base UI usage correct** — All interactive elements use Base UI. No hand-rolled dropdowns.

10. **lib/api.ts correctly centralizes HTTP** — All stores (except view-store) use fetchJson.

## Severity-Rated Summary

CRITICAL: None

HIGH:
- DC-1: drag-select.ts dead code (131 lines, 0 imports)
- DD-1: lib/linkify-ticket-ids.tsx imports components/ (inverted dependency)
- CF-6: filter-engine serializeFilters/deserializeFilters dead + duplicated in url-sync hook

MEDIUM (14 findings):
CF-1 STATUS_LABELS duplication | CF-2 status cycle duplication | CF-3 allTags duplication
CF-4 SORT_FIELDS duplication | CF-5 TICKET_ID_RE duplication | CF-7 STATUS_COLORS semantic mismatch
DD-2 filter-store circular dep | DD-3 view-store raw fetch | SO-2 getDefaultValue in wrong module
DLS-1 status cycle rule buried | DLS-2 useProjectViewSetup in app.tsx | DC-3 toggleCheckbox dead
DC-4 keybindings p+X unimplemented | CF-1/SO-1 STATUS_LABELS two owners

LOW: DC-5 plan.md in src/, DLS-3 getVisibleTickets inline, CF-8 popup CSS patterns

## Prioritized Refactoring Plan

P0 (delete dead code — zero risk):
1. Delete src/lib/drag-select.ts
2. Delete serializeFilters/deserializeFilters from filter-engine.ts
3. Delete/move ticket-detail-edit.plan.md

P1 (fix dependency direction):
4. Fix lib/linkify-ticket-ids.tsx → move to components/ or refactor to return tokens

P2 (consolidate convergence failures):
5. Fix STATUS_LABELS — remove from status-dot.tsx, import from types.ts
6. Extract cycleStatus() to lib/ticket-workflow.ts
7. Extract useAllTags() to hooks/use-all-tags.ts
8. Consolidate SORT_FIELDS in lib/types.ts
9. Consolidate TICKET_ID_RE in one location

P3 (fix module ownership):
10. Move getDefaultValue to filter-engine.ts
11. Add view API endpoints to lib/api.ts

P4 (fix circular dependency):
12. Push dirty tracking to app.tsx, remove notifyDirty() from filter-store.ts

P5 (minor cleanup):
13. Implement or remove keybindings 'p' and 'X'
14. Move useProjectViewSetup to hooks/
15. Fix STATUS_COLORS inconsistency across views

## Confidence & Caveats

HIGH confidence — all findings verified with code reads + grep, not inference.

CF-7 STATUS_COLORS: may be intentional design choice for graph view.
SP-1 createListInteraction factory: NOT a violation — factory is correct for component-scoped state.
DC-4 keybindings p+X: 'p' may be intentionally stubbed for future feature.
