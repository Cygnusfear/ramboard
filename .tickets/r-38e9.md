---
title: "Mid-mortem: Delphi architectural sprint + perf fix"
type: task
status: closed
priority: 3
tags:
  - mid-mortem
  - compaction
created: 2026-03-01
---

# Mid-mortem: Delphi Architectural Sprint + Perf Fix

## What Was Being Worked On

Full 3-tier architectural refactoring sprint originating from a Delphi (30+40) review of the Ramboard codebase. The review identified ~26 findings across dead code, convergence failures, dependency direction violations, state ownership issues, and user-visible bugs. Work was executed via the **blitz** skill — parallel worktree agents, sequential merge.

After all tiers completed, hooman noticed slow initial ticket load. Diagnosed and fixed. Then unified status colors and created router tickets.

## Progress — What's Done

### T1: Quick Wins (10/10 ✅)
- Deleted `drag-select.ts` (−131 lines), `serializeFilters`/`deserializeFilters` (−16), `ticket-detail-edit.plan.md` (−89)
- Consolidated: `STATUS_LABELS`, `SORT_FIELD_OPTIONS`, `STATUS_CYCLE`, `getDefaultValue`, `normalizeTag`, `TICKET_ID_RE`, urgent icon → `Warning`

### T2: Medium Refactors (8/8 ✅)
- **T2-01**: Fixed broken `v` shortcut — was using dead UIStore.viewMode instead of viewStore
- **T2-02**: Extracted `useAllTags()` hook — single source, 2 consumers
- **T2-03**: Linkify dep inversion fixed — pure tokenizer in `lib/`, rendering in `components/`
- **T2-04**: View API consolidated to `lib/api.ts`
- **T2-05**: Extracted `useProjectViewSetup` to `hooks/` (app.tsx −56 lines)
- **T2-06**: STATUS_COLORS unified — open=green, in_progress=amber, closed=grey, cancelled=red. Three canonical exports in `types.ts` (`STATUS_DOT_COLORS`, `STATUS_RING_COLORS`, `STATUS_HEX_COLORS`)
- **T2-07**: Deleted dead `toggleCheckbox`
- **T2-08**: Implemented `p` (cycle priority) and `X` (range select) keybindings

### T3: Structural Changes (4/5 ✅)
- **T3-01**: Unified selection ownership — UIStore canonical, engine uses callbacks
- **T3-02**: Removed dynamic import hack from filter-store (pushed dirty tracking to hook)
- **T3-03**: SKIPPED — `buildActivityEntries` returns JSX, not pure. Co-located with consumer. Fine as-is.
- **T3-04**: Extracted `computeLayout` to `lib/graph-layout.ts`
- **T3-05**: Extracted `BoardToolbar` to own file

### Performance Fix ✅
- `GET /api/projects` no longer parses every ticket — just reads config (instant sidebar)
- `parseTicketsDir` now uses `Promise.all` instead of sequential `for` loop (~3-5x faster)
- Eliminated double-parse on first load (was parsing active project twice)
- `ProjectSummary.counts` made optional (nothing consumed it)

### Status Color Unification ✅
- Single source in `types.ts` with three formats: Tailwind bg classes, ring classes, hex values
- Both `status-dot.tsx` and `graph-view.tsx` import from canonical source
- Hooman decision: open=green, in_progress=amber, closed=grey, cancelled=red

## Decisions Made

1. **T3-03 skip**: `buildActivityEntries` returns `React.ReactNode` — extracting to `lib/` would require splitting data from JSX (overengineered) or moving JSX into lib/ (wrong). Left as-is.
2. **Status color semantics**: Hooman chose open=green, closed=grey, in_progress=yellow/amber. Same everywhere — no graph-vs-list divergence.
3. **Merge order matters**: keyboard → hooks → api-deps (keyboard touches view-store methods, api-deps rewrites internals). Selection → extractions.
4. **Performance**: Don't parse all projects' tickets just for sidebar counts nobody displays. Lazy load per-project only.

## Open Threads — Future Work

### Ticket r-db91: Clean URL Structure
- Current: `/<project>?f=<encoded-JSON>&sf=created`
- Target: `/<project-id>/view/<viewId>` with named views that persist filter state
- Views stored server-side, URL just references view ID

### Ticket r-9f99: Router Integration
- wouter is already in use but route structure is flat
- `use-filter-url-sync.ts` is a 100-line mess doing manual URL ↔ store sync
- Plan: proper nested routes, delete filter-url-sync, consolidate route defs, move project/view resolution into route params
- Linked to r-db91

### Delphi Epic r-e89a: CLOSED
- All findings addressed or intentionally skipped with rationale

## Gotchas & Learnings

1. **Sequential file I/O was the perf killer** — `parseTicketsDir` read files one at a time. `Promise.all` is an obvious fix but was missed.
2. **Sidebar was parsing EVERY ticket for counts nothing displayed** — `ProjectSummary.counts` was in the type but no component read it. Pure waste.
3. **Graph view and list view had divergent color semantics** — same status, different colors. Graph used hex for SVG, StatusDot used Tailwind classes. Solution: canonical source with both formats.
4. **Blitz workflow works well** — 3 parallel workers per tier, sequential merge, zero conflicts across all 8 merges. Key: group tasks by file overlap.
5. **Type errors are only in `server/` (missing `@types/bun`)** — pre-existing, not from this work. `tsc --noEmit` on `src/` is clean.

## Commit History (this session)

```
bf4ac73 fix: unify status colors — single source in types.ts, open=green closed=grey everywhere
5cea085 chore: add router integration ticket (r-9f99), link to r-db91
3537668 perf: eliminate full ticket scan on startup, parallelize file reads
fc3310c refactor: push dirty tracking to hook, extract graph-layout and board-toolbar
528dc88 refactor: unify selection ownership — UIStore is canonical, engine uses callbacks
d8e8f99 refactor: fix linkify dep inversion, consolidate view API to lib/api.ts, delete dead toggleCheckbox
0ddfc63 refactor: extract useAllTags and useProjectViewSetup hooks
2295aef fix: wire v-shortcut to viewStore, implement p/X keybindings, delete dead UIStore.viewMode
998efa1 fix: deduplicate TICKET_ID_RE, fix urgent priority icon inconsistency
a9cc05b refactor: consolidate duplicated constants and logic
10df472 chore: delete dead code (drag-select, serialize fns, plan.md)
```

## Net Impact
- ~300 lines deleted net
- 8 convergence failures eliminated
- 2 user-visible bugs fixed (broken `v` shortcut, phantom keybindings)
- 1 dependency inversion fixed
- 3 dead code modules removed
- First load significantly faster (no full scan, parallel reads)
