---
id: r-15d3
status: closed
deps: []
links: []
created: 2026-03-01T10:46:12Z
type: task
priority: 1
assignee: Alexander Mangel
tags: [research, oracle, architecture]
---
# Oracle 1: Full 30+40 Architectural Review — Ramboard React SPA

## Framing Assessment

This review was commissioned as Oracle #1 in a Delphi consultation. Skepticism protocol applied: all primary sources read directly. The r-0cc6 ticket (context menu callback threading) represents a **completed, correct fix** — the codebase as committed shows zero callback threading in the menu system. The refactor commit `9804f4c` correctly implemented Option B from that review. The current codebase is the post-fix state.

No poisoned context detected. The framing in the mission ticket accurately describes the observable state.

---

## Codebase Map

### Architecture Layers

```
Infrastructure:    lib/types.ts, lib/api.ts
Domain/Pure:       lib/filter-engine.ts, lib/list-interaction.ts, lib/tag-mutations.ts,
                   lib/drag-select.ts, lib/keybindings.ts, lib/linkify-ticket-ids.tsx,
                   lib/markdown.ts, lib/ticket-options.tsx
State (Stores):    stores/ticket-store.ts, stores/project-store.ts, stores/filter-store.ts,
                   stores/ui-store.ts, stores/view-store.ts
Hooks:             hooks/use-filtered-tickets.ts, hooks/use-filter-url-sync.ts,
                   hooks/use-keyboard.ts, hooks/use-known-ticket-ids.ts,
                   hooks/use-linkified-markdown.tsx, hooks/use-navigate.ts
Presentation:      app.tsx, components/*.tsx
Entry:             main.tsx
```

### File Inventory (48 files, all read)

| File | Lines | Role | Status |
|------|-------|------|--------|
| lib/types.ts | 67 | Data types, constants | Clean |
| lib/api.ts | 51 | HTTP client | Clean |
| lib/filter-engine.ts | 289 | Pure filter/sort engine | Has dead exports |
| lib/list-interaction.ts | 302 | Interaction state machine | Excellent design |
| lib/drag-select.ts | 132 | Old drag engine | **DEAD CODE** |
| lib/tag-mutations.ts | 31 | Tag toggle business rule | Clean, post-refactor |
| lib/keybindings.ts | 38 | Keybinding definitions | Clean |
| lib/linkify-ticket-ids.tsx | 57 | Pure ticket ID linkifier | Clean |
| lib/markdown.ts | 81 | Markdown↔HTML conversion | Clean |
| lib/ticket-options.tsx | 34 | Status/priority/type options | Has icon inconsistency |
| stores/ticket-store.ts | ~110 | Ticket CRUD state | Clean |
| stores/project-store.ts | ~55 | Project list state | Clean |
| stores/filter-store.ts | ~100 | Filter/sort state | Misplaced helper fn |
| stores/ui-store.ts | ~65 | UI state (selection, highlights) | Dead state (viewMode) |
| stores/view-store.ts | ~90 | Saved views persistence | Clean |
| hooks/use-filtered-tickets.ts | 23 | Derived filtered list | Clean |
| hooks/use-filter-url-sync.ts | 128 | Filter↔URL sync | Own serialization format |
| hooks/use-keyboard.ts | 161 | Global keyboard bindings | Business logic in hook |
| hooks/use-known-ticket-ids.ts | 12 | Known IDs set | Clean |
| hooks/use-linkified-markdown.tsx | 51 | Markdown link components | Clean |
| hooks/use-navigate.ts | 50 | View-transition navigation | Clean |
| app.tsx | 171 | Routing + data setup | Business logic in setup hook |
| components/list-view.tsx | 399 | Virtual ticket list | Split ownership issue |
| components/ticket-context-menu.tsx | 328 | Context menu + DotMenu | Clean (post-refactor) |
| components/ticket-detail.tsx | 205 | Ticket detail page | Status cycle duplication |
| components/board-view.tsx | 430 | Board view with DnD columns | Minor god-module concern |
| components/board-column.tsx | 114 | Single board column | Clean |
| components/graph-view.tsx | 395 | DAG graph view | Domain logic in component |
| components/filter-bar.tsx | 129 | Active filter chips | Clean |
| components/filter-primitives.tsx | 281 | Shared filter editors | Clean (explicit per comment) |
| components/header-bar.tsx | 239 | View controls + view picker | Clean |
| components/project-rail.tsx | 213 | Project nav sidebar | Clean |
| components/command-palette.tsx | 67 | ⌘K search | Clean |
| components/bulk-action-bar.tsx | 61 | Multi-select actions | Clean |
| components/column-editor.tsx | 192 | Board column config popover | Misplaced import |
| components/inline-select.tsx | 70 | Inline dropdown select | Clean |
| components/tag-editor.tsx | 145 | Tag add/remove UI | Duplicated allTags logic |
| components/tag-pill.tsx | 190 | Tag display + auto-overflow | Complex but justified |
| components/ticket-link.tsx | 33 | Clickable ticket ID | Clean |
| components/linkified-text.tsx | 29 | Auto-link in plain text | Clean |
| components/copyable-id.tsx | 37 | Copy-to-clipboard ID | Clean |
| components/ticket-activity.tsx | 148 | Activity timeline | Domain logic in component |
| components/ticket-body-editor.tsx | 233 | TipTap rich text editor | Justified complexity |
| components/ticket-link-plugin.ts | 74 | ProseMirror decoration plugin | Clean |
| components/slash-command.tsx | 290 | / command menu in editor | Imperative DOM pattern |
| components/keyboard-help.tsx | 56 | Keyboard shortcuts dialog | Clean |
| components/status-dot.tsx | 47 | Status indicator | Duplicate constant |
| components/priority-icon.tsx | 26 | Priority icon | Inconsistent icon set |

---

## Findings Per Principle

### 40.01 — State Ownership

**Finding 1 (HIGH): Selection state has split ownership**
- `list-interaction.ts` maintains `selection: Set<string>` as the canonical selection state
- `list-view.tsx:199` syncs it to `useUIStore.selectedIds` via a useEffect:
  ```typescript
  useEffect(() => {
    useUIStore.setState({ selectedIds: viewState.selection });
  }, [viewState.selection]);
  ```
- `bulk-action-bar.tsx` reads `useUIStore.selectedIds`
- `use-keyboard.ts` reads `useUIStore.getState().selectedIds`
- Result: two owners of "which tickets are selected" — the interaction engine (primary) and UIStore (mirror). If the sync effect fires late or is disrupted, they silently diverge.
- **Root cause**: `BulkActionBar` was wired before `ListInteraction` was extracted, so it reads from UIStore. The ListInteraction engine doesn't need UIStore at all.
- **Fix**: Let BulkActionBar read from the interaction engine directly, OR lift the selection Set into UIStore as the only source of truth (and have the engine write to UIStore directly via `useUIStore.getState().setState()` on state change).

**Finding 2 (MEDIUM): `useUIStore.viewMode` is dead state**
- `useUIStore.viewMode` is initialized to `'list'`, has `setViewMode` and `toggleViewMode` actions
- `use-keyboard.ts:144` calls `ui.toggleViewMode()` when 'v' is pressed
- BUT: `app.tsx:34` derives viewMode from `useViewStore`: `const viewMode = activeView?.mode ?? 'list'`
- `header-bar.tsx:86` also derives viewMode from `useViewStore`: `const viewMode = activeView?.mode ?? 'list'`
- **Nothing reads `useUIStore.viewMode`** for actual rendering decisions
- Result: pressing 'v' on the keyboard updates `useUIStore.viewMode` but has zero effect on the displayed view — the keyboard shortcut is silently broken
- Two representations of "current view mode": `useUIStore.viewMode` (dead) and `useViewStore.activeView.mode` (live)

**Finding 3 (LOW): `useFilterStore.setState()` called directly from outside the store**
- `app.tsx:69`: `useFilterStore.setState({ filters, sortField, sortDir })` — loads saved view filters
- `use-filter-url-sync.ts:98`: `useFilterStore.setState(restored)` — restores from URL
- These bypass the store's defined action methods (`addFilter`, `updateFilter`, etc.) which all call `notifyDirty()`
- The callers must know to avoid triggering dirty state — implicit coupling, not enforced
- **Current behavior is correct** (app.tsx calls `markClean()` after, url-sync doesn't need dirty), but brittle if the pattern is copied without understanding

---

### 40.02 — Module Boundaries

**Finding 4 (HIGH): `drag-select.ts` is dead code**
- `lib/drag-select.ts` (132 lines) exports: `createDragSelectState`, `dragStart`, `dragMove`, `dragEnd`, `dragClear`, `dragSelectAll`
- **Zero imports** — `rg "from.*drag-select" src/` returns nothing
- The commit `4651540 refactor(list): replace hooks spaghetti with pure state machine` created `list-interaction.ts` as a replacement but left `drag-select.ts` in place
- This is the "Duplicate-And-Forget" anti-pattern from 30.01: code was written to a new location but old location was not deleted
- **Fix**: Delete `lib/drag-select.ts`

**Finding 5 (MEDIUM): `getDefaultValue` misplaced in store file**
- `stores/filter-store.ts:83`: exports `function getDefaultValue(_field: FilterField, operator: FilterOperator): FilterClause['value']`
- This is a pure function with zero store dependency (the `_field` param is even unused)
- It belongs in `lib/filter-engine.ts` with the other filter logic
- `column-editor.tsx:17` imports it from the store: `import { getDefaultValue } from '@/stores/filter-store'` — a component importing a pure utility from a store file
- **Fix**: Move to `lib/filter-engine.ts`, update the one consumer (`column-editor.tsx`)

**Finding 6 (MEDIUM): `filter-engine.ts` has dead exports**
- `filter-engine.ts` exports `serializeFilters(filters: FilterSet): string` and `deserializeFilters(raw: string): FilterSet`
- **Zero imports** — these functions are unused across the entire codebase
- URL serialization is handled by `use-filter-url-sync.ts` with a completely different strategy (URLSearchParams with separate keys vs encoded JSON blob)
- **Fix**: Delete `serializeFilters` and `deserializeFilters` from `filter-engine.ts`, OR unify the serialization strategy

**Finding 7 (LOW): `board-view.tsx` has two independent concerns**
- 430 lines; contains `PRESETS`, `BoardToolbar`, `SORT_FIELD_OPTIONS`, `SortableColumn`, and `BoardView`
- `BoardToolbar` (lines 77-173) is independently testable and has no coupling to `BoardView` except via callbacks — it would change when toolbar UI changes, independently of board DnD logic
- Not critical (still under 500 lines), but the boundary exists

**Finding 8 (LOW): `buildActivityEntries` domain logic in component file**
- `ticket-activity.tsx:22-90`: `function buildActivityEntries(ticket: Ticket, allTickets: TicketSummary[]): ActivityEntry[]`
- This is a pure function (no React, no hooks) that computes domain logic (reverse dependency/link resolution)
- Should live in `lib/ticket-activity.ts` to be independently testable
- Currently it's trapped inside a component file

**Finding 9 (LOW): `computeLayout` domain logic in component file**
- `graph-view.tsx:38-90`: `function computeLayout(tickets: TicketSummary[]): GraphLayout`
- Pure function computing dagre graph layout — no React, no hooks
- Should live in `lib/graph-layout.ts` to be independently testable

---

### 40.03 — Dependency Direction

**Finding 10 (MEDIUM): `filter-store.ts` → `view-store.ts` hidden coupling via dynamic import**
- `filter-store.ts:33-36`:
  ```typescript
  function notifyDirty() {
    import('@/stores/view-store').then(m => m.useViewStore.getState().markDirty())
  }
  ```
- This is store-imports-store (same layer), avoiding circular at load time — but the coupling is hidden from the static import graph
- The consequence: filter store changes trigger view-store state changes, but this dependency is invisible unless you look at the runtime behavior
- Both stores are at the same layer, so there's no upward violation. But the hidden coupling creates maintenance risk: anyone refactoring the stores must discover this dynamic import to understand full behavior
- **Alternative**: Have app.tsx subscribe to filter store and call `markDirty()` on the view store — explicit, visible coupling at the appropriate orchestration layer

**Finding 11 (LOW): `column-editor.tsx` imports pure utility from store**  
- See Finding 5 — `import { getDefaultValue } from '@/stores/filter-store'`
- Not a direction violation (component → store is correct), but a boundary violation (pure utility living in wrong module)

---

### 40.04 — Domain Logic Separation

**Finding 12 (HIGH): `useProjectViewSetup` in app.tsx mixes view orchestration with data management**
- `app.tsx:27-75`: The `useProjectViewSetup` hook contains business rules:
  1. "When switching projects, clear active ticket" — behavioral rule
  2. "Load saved view filters, but only if URL has no filter params" — priority resolution rule
  3. "When views load, sync activeViewId from URL viewId param" — routing rule
- These rules belong in a domain module or store action, not in a React hook inside the routing component
- The most problematic: `app.tsx:61-70`:
  ```typescript
  const hasUrlFilters = window.location.search.includes('f=') || ...
  if (hasUrlFilters) { useViewStore.getState().markClean(); return }
  const { filters, sortField, sortDir } = activeView.list
  useFilterStore.setState({ filters, sortField, sortDir })
  useViewStore.getState().markClean()
  ```
  — reads `window.location.search` directly in a React hook, calls two store's `.getState()` imperatively, contains the filter/URL priority rule

**Finding 13 (HIGH): Status cycle business rule implemented twice**
- `lib/list-interaction.ts:27-30`:
  ```typescript
  const STATUS_CYCLE: Record<string, string> = {
    open: 'in_progress',
    in_progress: 'closed',
    closed: 'open',
  }
  ```
- `components/ticket-detail.tsx:50-52`:
  ```typescript
  const newStatus = activeTicket.status === 'closed' ? 'open' :
                    activeTicket.status === 'open' ? 'in_progress' :
                    activeTicket.status === 'in_progress' ? 'closed' : 'open'
  ```
- Same business rule (status cycle order), two implementations. The `ticket-detail.tsx` version is a ternary chain instead of a map lookup — different style, same intent.
- **30.02 convergence failure**. If the cycle order changes (e.g., add `review` status between `in_progress` and `closed`), one implementation will be updated but not the other.
- **Fix**: Export `STATUS_CYCLE` from `lib/types.ts` or `lib/list-interaction.ts`, use it in `ticket-detail.tsx`

**Finding 14 (MEDIUM): Tag normalization rule in TagEditor**
- `tag-editor.tsx:59`:
  ```typescript
  const tag = search.trim().toLowerCase().replace(/\s+/g, '-')
  ```
- This is a business rule (tag format: lowercase, dashes-for-spaces) embedded in the component callback
- Should be a pure function in `lib/tag-mutations.ts` (which already exists and handles tag logic)
- **Fix**: `export function normalizeTag(input: string): string` in `tag-mutations.ts`

---

### 40.05 — Singleton Patterns

**No violations found.**

- All Zustand stores are module-level singletons via `create()` — correct
- `createListInteraction()` is a factory used once per ListView mount, stored in `useRef` — correct (one instance per component mount, not over-engineered)
- No unnecessary classes or closure patterns creating hidden singletons
- `markdown.ts` uses a module-level `TurndownService` instance — correct singleton pattern

---

### 30.01 — Refactor Guide Issues

**Finding 15 (HIGH): Dead code from incomplete refactor — drag-select.ts**  
See Finding 4. The "Duplicate-And-Forget" anti-pattern: `list-interaction.ts` replaced `drag-select.ts` but the old module was not deleted. The refactor is 90% complete. The missing 10%: `rm lib/drag-select.ts`.

**Finding 16 (MEDIUM): Dead exports in filter-engine.ts**  
See Finding 6. `serializeFilters` and `deserializeFilters` were created with the initial filter system but the actual URL serialization was implemented differently in `use-filter-url-sync.ts`. Same "wrote code, nothing wired it" pattern.

---

### 30.02 — Convergence Failures (same concept, different code)

**Convergence Failure 1 (HIGH): `allTags` computation duplicated**
- `ticket-context-menu.tsx:92-98`: Computes unique sorted tags from all tickets
- `tag-editor.tsx:29-34`: Same computation, same logic, different variable names

Both do:
```typescript
const allTags = useMemo(() => {
  const set = new Set<string>()
  for (const t of allTickets) {
    if (Array.isArray(t.tags)) t.tags.forEach(tag => set.add(tag))
  }
  return Array.from(set).sort()
}, [allTickets])
```
Exact structural match. This should be a hook: `useAllTags()` in `hooks/use-all-tags.ts` or a pure function in `lib/tag-mutations.ts`.

**Convergence Failure 2 (HIGH): `SORT_FIELD_OPTIONS` / `SORT_FIELDS` duplicated**
- `board-view.tsx:184-191`: `SORT_FIELD_OPTIONS: { value: SortField; label: string }[]` with 5 entries
- `column-editor.tsx:28-35`: `SORT_FIELDS: { value: SortField; label: string }[]` with same 5 entries, different name
- Same data, different variable names, different files. Should be a single constant in `lib/types.ts` or `lib/filter-engine.ts`.

**Convergence Failure 3 (HIGH): Status cycle implemented twice**
See Finding 13.

**Convergence Failure 4 (MEDIUM): `STATUS_LABELS` in `status-dot.tsx` duplicates `lib/types.ts`**
- `lib/types.ts:32-39`: `export const STATUS_LABELS: Record<string, string>` — canonical
- `status-dot.tsx:15-20`: Local `const STATUS_LABELS` with same four entries
- The component file doesn't import from types.ts — it re-declares the constant locally
- `graph-view.tsx`, `board-view.tsx`, `filter-primitives.tsx` correctly import from `lib/types.ts`
- **Fix**: Delete local `STATUS_LABELS` from `status-dot.tsx`, import from `lib/types.ts`

**Convergence Failure 5 (MEDIUM): Urgent priority icon inconsistency**
- `lib/ticket-options.tsx:19`: Priority 0 (Urgent) uses `ArrowFatDown` (rotated 180° to point up) — red
- `components/priority-icon.tsx:9`: Priority 0 (Urgent) uses `Warning` — red
- These render in different contexts: ticket-options for context menus, priority-icon for list rows/cards/graph
- A user sees the same "urgent" priority represented by two different icons depending on where they look

**Convergence Failure 6 (LOW): Filter serialization strategies**
- `lib/filter-engine.ts` exports `serializeFilters(filters: FilterSet): string` — encodes the filter set as JSON → encodeURIComponent
- `hooks/use-filter-url-sync.ts:11-35`: Implements its own `serializeToSearch()` — uses URLSearchParams with separate keys for filters, search, sort, sortDir
- Different scope (filter-engine only handles FilterSet; url-sync handles full filter state), different format
- The filter-engine versions are unused (dead code); the url-sync version is live
- Partial convergence failure: both exist to "serialize filter state" but with different strategies

---

## Severity-Rated Finding Summary

| # | Finding | Principle | Severity | File(s) |
|---|---------|-----------|----------|---------|
| 1 | Selection split ownership (listInteraction + UIStore) | 40.01 | **HIGH** | list-view.tsx:199, ui-store.ts |
| 2 | viewMode dead state in UIStore | 40.01 | **HIGH** | ui-store.ts, use-keyboard.ts:144 |
| 4 | drag-select.ts dead code (incomplete refactor) | 30.01, 40.02 | **HIGH** | lib/drag-select.ts |
| 12 | useProjectViewSetup mixes routing + domain rules | 40.04 | **HIGH** | app.tsx:27-75 |
| 13 | Status cycle implemented twice | 40.04, 30.02 | **HIGH** | list-interaction.ts:27, ticket-detail.tsx:50 |
| CF1 | allTags duplicated in 2 files | 30.02 | **HIGH** | ticket-context-menu.tsx:92, tag-editor.tsx:29 |
| CF2 | SORT_FIELD_OPTIONS/SORT_FIELDS duplicated | 30.02 | **HIGH** | board-view.tsx:184, column-editor.tsx:28 |
| CF3 | STATUS_CYCLE duplicated | 30.02 | **HIGH** | (same as Finding 13) |
| 5 | getDefaultValue misplaced in store | 40.02 | **MEDIUM** | filter-store.ts:83, column-editor.tsx:17 |
| 6 | serializeFilters/deserializeFilters dead exports | 30.01, 40.02 | **MEDIUM** | filter-engine.ts |
| 10 | filter-store→view-store hidden dynamic import | 40.03 | **MEDIUM** | filter-store.ts:33 |
| 14 | Tag normalization rule in TagEditor component | 40.04 | **MEDIUM** | tag-editor.tsx:59 |
| CF4 | STATUS_LABELS duplicated in status-dot.tsx | 30.02 | **MEDIUM** | status-dot.tsx:15, types.ts:32 |
| CF5 | Urgent priority icon inconsistency | 30.02 | **MEDIUM** | ticket-options.tsx:19, priority-icon.tsx:9 |
| 3 | useFilterStore.setState() bypasses action methods | 40.01 | **LOW** | app.tsx:69, use-filter-url-sync.ts:98 |
| 7 | board-view.tsx could extract BoardToolbar | 40.02 | **LOW** | board-view.tsx:77 |
| 8 | buildActivityEntries in component file | 40.04 | **LOW** | ticket-activity.tsx:22 |
| 9 | computeLayout in component file | 40.04 | **LOW** | graph-view.tsx:38 |
| 11 | column-editor imports utility from store | 40.03 | **LOW** | column-editor.tsx:17 |
| CF6 | Filter serialization strategy divergence | 30.02 | **LOW** | filter-engine.ts, use-filter-url-sync.ts |

---

## Prioritized Refactoring Recommendations

### P0 — Bug-class issues (user-visible, silently broken)

**P0.1: Fix 'v' keyboard shortcut (viewMode dead state)**
- `useKeyboard.ts:144` calls `ui.toggleViewMode()` but this updates `useUIStore.viewMode` which nothing reads
- The 'v' keyboard shortcut for toggling view mode is silently broken
- Fix: update `use-keyboard.ts` to switch views through the view store instead of UI store
  ```typescript
  // Replace:
  ui.toggleViewMode()
  
  // With:
  const currentMode = useViewStore.getState().views.find(v => v.id === useViewStore.getState().activeViewId)?.mode ?? 'list'
  const targetMode = currentMode === 'list' ? 'board' : 'list'
  const target = useViewStore.getState().views.find(v => v.mode === targetMode)
  if (target) { useViewStore.getState().setActiveView(target.id) }
  else { useViewStore.getState().updateViewLocal(useViewStore.getState().activeViewId!, { mode: targetMode }) }
  ```
- After fix: remove `viewMode`, `setViewMode`, `toggleViewMode` from `UIStore` (dead state cleanup)

### P1 — Structural debt (correctness risk if extended)

**P1.1: Fix selection ownership split**
- Decision: make `useUIStore.selectedIds` the canonical selection state
- Have `listInteraction` engine write to `useUIStore.getState().setState()` instead of calling `onChange`'s `selection` field
- OR: have BulkActionBar accept selection as a prop from ListView
- This eliminates the useEffect sync, making the data flow a single write path

**P1.2: Delete drag-select.ts**
- `lib/drag-select.ts` has zero importers. Delete it.
- Verify: `rg "drag-select" src/` returns zero results after deletion

**P1.3: Consolidate status cycle to single source**
- Export `STATUS_CYCLE` from `lib/types.ts`:
  ```typescript
  export const STATUS_CYCLE: Record<string, string> = {
    open: 'in_progress',
    in_progress: 'closed',
    closed: 'open',
  }
  ```
- Update `list-interaction.ts` and `ticket-detail.tsx` to import it

**P1.4: Consolidate allTags computation**
- Add to `lib/tag-mutations.ts`:
  ```typescript
  export function collectAllTags(tickets: { tags?: string[] }[]): string[] {
    const set = new Set<string>()
    for (const t of tickets) {
      if (Array.isArray(t.tags)) t.tags.forEach(tag => set.add(tag))
    }
    return Array.from(set).sort()
  }
  ```
- Replace both `allTags` useMemos in `ticket-context-menu.tsx` and `tag-editor.tsx`

**P1.5: Consolidate SORT_FIELD_OPTIONS**
- Move the sort field options array to `lib/types.ts` or `lib/filter-engine.ts` as a shared constant
- Remove local definitions from `board-view.tsx` and `column-editor.tsx`

### P2 — Code quality improvements

**P2.1: Move `getDefaultValue` from filter-store to filter-engine**
- Pure function with zero store dependency, exported for column-editor
- Moving it to filter-engine.ts makes imports more coherent

**P2.2: Delete dead exports from filter-engine.ts**
- `serializeFilters` and `deserializeFilters` have zero importers — delete them

**P2.3: Fix STATUS_LABELS duplication in status-dot.tsx**
- Remove local `STATUS_LABELS` declaration, import from `lib/types.ts`

**P2.4: Fix Urgent priority icon inconsistency**
- Decide: use `Warning` (current priority-icon) or `ArrowFatDown` (current ticket-options) for Urgent
- Apply consistently to both files
- Recommendation: `Warning` is semantically clearer for "urgent"

**P2.5: Make filter-store → view-store dependency explicit**
- Replace the dynamic import in `notifyDirty()` with a subscription registered at app init
- App.tsx subscribes to filterStore changes and calls `viewStore.markDirty()` when appropriate

**P2.6: Extract `buildActivityEntries` to lib/**
- Move pure function to `lib/ticket-activity.ts`
- Component becomes: `const entries = useMemo(() => buildActivityEntries(activeTicket, tickets), [...])`

**P2.7: Extract `computeLayout` to lib/**
- Move pure function to `lib/graph-layout.ts`
- Component becomes cleaner, function is testable

**P2.8: Extract tag normalization to lib/tag-mutations.ts**
- `export function normalizeTag(input: string): string { return input.trim().toLowerCase().replace(/\s+/g, '-') }`
- Use in `tag-editor.tsx`

---

## What Is Good About This Architecture

This codebase has significant architectural strengths worth preserving:

1. **`list-interaction.ts` is exemplary 40.04 design.** A pure TypeScript state machine with zero React dependency, fully testable, clean factory interface. This is exactly how complex UI interactions should be structured.

2. **`filter-engine.ts` is correctly pure.** No React, no stores — just computation. The `applyFiltersAndSort` function is independently testable.

3. **Post-refactor context menu (`ticket-context-menu.tsx`) is clean.** `useMenuActions` hook owns both reads and writes. Zero callback threading. Single place to add new menu actions. This is what Option B from r-0cc6 looks like in practice.

4. **`tag-mutations.ts` correctly extracted the tag-toggle business rule.** The `toggleTagForTickets` pure function proves the principle works — testable, single-sourced.

5. **All interactive elements use Base UI (per AGENTS.md).** No hand-rolled dropdowns, modals, or toggles anywhere.

6. **`useFilteredTickets` uses primitive selectors.** Correctly avoids the infinite render loop problem (addressed in r-90d6) by subscribing to primitive values, not derived state.

7. **`useNavigate` correctly abstracts view transitions.** Single hook wrapping the browser View Transitions API. All navigation goes through one path.

8. **Zustand stores are well-scoped.** Five stores, each with a single concern. No god stores. Correct use of `getState()` for imperative access in callbacks.

9. **Virtual lists in both ListView and BoardColumn.** Both use `@tanstack/react-virtual` correctly with fixed heights.

10. **`linkify-ticket-ids.tsx` is a pure utility correctly extracted.** Reused by `linkified-text.tsx`, `use-linkified-markdown.tsx`, and `ticket-link-plugin.ts` via a single implementation.

11. **DnD implementation is clean.** @dnd-kit used correctly in both board columns and project rail. Optimistic updates with server persistence in background.

---

## Confidence & Caveats

**Confidence: High (9/10)**

Every file in `src/` has been read completely. All findings are based on direct code inspection, not inference. The dependency graph was traced by reading imports in each file.

**Caveats:**
1. The 'v' keyboard shortcut bug (Finding 2) depends on there being no other subscriber to `useUIStore.viewMode` that I missed. Confirmed by `grep -n 'viewMode' src/ -r` output — only definitions and writers, no readers outside `ui-store.ts` itself.

2. The `drag-select.ts` dead code claim was verified by confirming `rg "from.*drag-select" src/` returns nothing. However, `list-interaction.ts` imports types that are conceptually similar — it does NOT import from `drag-select.ts`, but a human might have intended it as documentation.

3. The `app.tsx` view-filter priority logic may be intentionally placed there due to its dependency on `window.location.search` and timing with view load — this is acknowledged but still flagged as a 40.04 concern because the business rule ("URL overrides saved view") should be documented/extracted rather than embedded in a setup hook.

4. No test files were found in `src/`. All "testable" assessments assume tests would be written if the domain logic were properly extracted.

**Scope note:** This review covers `src/` only. The server (`server/`) was not reviewed. The assessment focuses on the React SPA architecture as specified.



## Goal
Complete architectural review of Ramboard React SPA applying all 40.xx and 30.xx playbook principles to all 48 files in src/.

## Acceptance Criteria
- [ ] Every file in src/ has been read and assessed (48 files)
- [ ] Each violated principle cited with specific file + line references
- [ ] Convergence failures identified with exact code locations
- [ ] State ownership mapped — all split ownership documented
- [ ] Dead code identified with verification method
- [ ] Severity rating for each finding
- [ ] Prioritized refactoring recommendations (P0/P1/P2)
- [ ] What is GOOD about the architecture documented

## Verification
- [ ] Ticket contains codebase map with all 48 files
- [ ] viewMode dead state claim verified by grep output
- [ ] drag-select dead code verified by import search
- [ ] STATUS_LABELS duplication locations specified
- [ ] STATUS_CYCLE duplication locations specified
- [ ] allTags duplication locations specified
- [ ] SORT_FIELD_OPTIONS duplication locations specified

## Worktree
- .
